openapi: 3.0.3
info:
  title: Ctxfy API
  version: "1.0.0"
  description: |
    Ctxfy API for AI context management: spaces, sources, artifacts, and file uploads.
    Save conversation state as snapshots, extract structured context and artifacts.
    API access is available on Pro and Enterprise plans.
    All routes under `/api/v1` require authentication via `Authorization: Bearer <api_key>`.
    Public endpoints: `/health`, `/metrics`.

    **Rate limiting:** Free plan — 10 req/min, Pro and above — 100 req/min.
    Response headers: `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`.
    On exceed: 429 Too Many Requests, `Retry-After` header.
servers:
  - url: /
    description: API base URL (override with your deployment base)
paths:
  /health:
    get:
      summary: Health check
      description: Returns service and dependency health status.
      responses:
        "200":
          description: Health status response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthCheckEnvelope"
        "500":
          description: Health check failure
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
  /metrics:
    get:
      summary: Metrics
      description: Prometheus metrics endpoint.
      responses:
        "200":
          description: Metrics output
          content:
            text/plain:
              schema:
                type: string
  /api/v1/spaces:
    post:
      summary: Create space
      security:
        - FirebaseBearer: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateSpaceRequest"
      responses:
        "201":
          description: Space created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SpaceEnvelope"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
    get:
      summary: List spaces
      security:
        - FirebaseBearer: []
      responses:
        "200":
          description: List of spaces
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SpaceListEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
  /api/v1/spaces/{spaceId}:
    get:
      summary: Get space
      security:
        - FirebaseBearer: []
      parameters:
        - $ref: "#/components/parameters/SpaceId"
      responses:
        "200":
          description: Space response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SpaceEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "404":
          description: Space not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
    put:
      summary: Update space
      security:
        - FirebaseBearer: []
      parameters:
        - $ref: "#/components/parameters/SpaceId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateSpaceRequest"
      responses:
        "200":
          description: Updated space
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SpaceEnvelope"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "404":
          description: Space not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
    delete:
      summary: Delete space
      security:
        - FirebaseBearer: []
      parameters:
        - $ref: "#/components/parameters/SpaceId"
      responses:
        "204":
          description: Deleted
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "404":
          description: Space not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
  /api/v1/spaces/{spaceId}/collections:
    post:
      summary: Create collection
      security:
        - FirebaseBearer: []
      parameters:
        - $ref: "#/components/parameters/SpaceId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateCollectionRequest"
      responses:
        "201":
          description: Collection created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CollectionEnvelope"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "404":
          description: Space or parent collection not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "409":
          description: Collection already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
    get:
      summary: Get collection tree
      security:
        - FirebaseBearer: []
      parameters:
        - $ref: "#/components/parameters/SpaceId"
      responses:
        "200":
          description: Collection tree response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CollectionTreeEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "404":
          description: Space not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
  /api/v1/spaces/{spaceId}/sources:
    get:
      summary: List sources in a space
      security:
        - FirebaseBearer: []
      parameters:
        - $ref: "#/components/parameters/SpaceId"
      responses:
        "200":
          description: Sources response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SpaceSourcesEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "404":
          description: Space not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
    post:
      summary: Create source
      security:
        - FirebaseBearer: []
      parameters:
        - $ref: "#/components/parameters/SpaceId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateSourceRequest"
      responses:
        "201":
          description: Source created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SourceEnvelope"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "404":
          description: Space or collection not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
  /api/v1/collections/{collectionId}/sources:
    get:
      summary: List sources in a collection
      security:
        - FirebaseBearer: []
      parameters:
        - $ref: "#/components/parameters/CollectionId"
      responses:
        "200":
          description: Sources response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SourceListEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "404":
          description: Collection not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
  /api/v1/sources/{sourceId}:
    get:
      summary: Get source
      security:
        - FirebaseBearer: []
      parameters:
        - $ref: "#/components/parameters/SourceId"
      responses:
        "200":
          description: Source response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SourceEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "404":
          description: Source not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
    patch:
      summary: Patch source
      description: Partially updates source metadata.
      security:
        - FirebaseBearer: []
      parameters:
        - $ref: "#/components/parameters/SourceId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PatchSourceRequest"
      responses:
        "200":
          description: Updated source
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SourceEnvelope"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "404":
          description: Source not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
    delete:
      summary: Delete source
      security:
        - FirebaseBearer: []
      parameters:
        - $ref: "#/components/parameters/SourceId"
      responses:
        "204":
          description: Deleted
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "404":
          description: Source not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
  /api/v1/sources/{sourceId}/toggle-pin:
    patch:
      summary: Toggle pin
      security:
        - FirebaseBearer: []
      parameters:
        - $ref: "#/components/parameters/SourceId"
      responses:
        "200":
          description: Updated source
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SourceEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "404":
          description: Source not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
  /api/v1/sources/{sourceId}/restore:
    post:
      summary: Restore source
      description: Restores a previously deleted (soft-deleted) source.
      security:
        - FirebaseBearer: []
      parameters:
        - $ref: "#/components/parameters/SourceId"
      responses:
        "200":
          description: Restored source
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SourceEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "404":
          description: Source not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
  /api/v1/sources/{sourceId}/reprocess:
    post:
      summary: Reprocess source
      description: Triggers reprocessing of a source. Source must be COMPLETED or FAILED with content available.
      security:
        - FirebaseBearer: []
      parameters:
        - $ref: "#/components/parameters/SourceId"
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SourceReprocessRequest"
      responses:
        "200":
          description: Reprocess initiated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "404":
          description: Source not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
  /api/v1/sources/{sourceId}/cancel:
    post:
      summary: Cancel source processing
      description: Cancels source processing.
      security:
        - FirebaseBearer: []
      parameters:
        - $ref: "#/components/parameters/SourceId"
      responses:
        "200":
          description: Cancel initiated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "404":
          description: Source not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
  /api/v1/sources/{sourceId}/refresh:
    post:
      summary: Refresh source
      description: Re-fetches source content. Only URL or FILE sources.
      security:
        - FirebaseBearer: []
      parameters:
        - $ref: "#/components/parameters/SourceId"
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SourceRefreshRequest"
      responses:
        "200":
          description: Refresh initiated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageEnvelope"
        "400":
          description: Invalid (e.g. source type not URL/FILE)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "404":
          description: Source not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
  /api/v1/spaces/{spaceId}/artifacts:
    get:
      summary: List artifacts in a space
      security:
        - FirebaseBearer: []
      parameters:
        - $ref: "#/components/parameters/SpaceId"
      responses:
        "200":
          description: Artifacts response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ArtifactListEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "404":
          description: Space not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
  /api/v1/source-artifact/{artifactId}/process:
    put:
      summary: Process artifact
      security:
        - FirebaseBearer: []
      parameters:
        - $ref: "#/components/parameters/ArtifactId"
      responses:
        "200":
          description: Processing initiated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "404":
          description: Artifact not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
  /api/v1/source-artifact/{artifactId}/promote:
    put:
      summary: Promote artifact
      description: "Promotes artifact to space. Optional body: title, description."
      security:
        - FirebaseBearer: []
      parameters:
        - $ref: "#/components/parameters/ArtifactId"
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PromoteArtifactRequest"
      responses:
        "200":
          description: Promotion initiated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "404":
          description: Artifact not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
  /api/v1/api-keys:
    post:
      summary: Create API key for user
      description: Creates a new API key for the current user. The key gives access to all resources of the user. The raw key is returned only once in the response.
      security:
        - FirebaseBearer: []
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateApiKeyRequest"
      responses:
        "201":
          description: API key created (raw key in response, store securely)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiKeyResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
    get:
      summary: List API keys for user
      security:
        - FirebaseBearer: []
      responses:
        "200":
          description: List of API keys (without secrets)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ListApiKeysResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
  /api/v1/api-keys/{keyId}:
    delete:
      summary: Revoke API key
      security:
        - FirebaseBearer: []
      parameters:
        - $ref: "#/components/parameters/KeyId"
      responses:
        "204":
          description: Key revoked
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "404":
          description: Key not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
  /api/v1/support/tickets:
    post:
      summary: Create support ticket
      description: |
        Creates a support ticket: request body contains type, reply address (e.g. email), and message.
        The backend enriches with current user id, subscription plan, and token balance; persists the ticket
        in the database (support_tickets); and sends the same content to the support address (SUPPORT_EMAIL).
        Email backend is chosen by SUPPORT_EMAIL_SENDER: "sendgrid" (default) or "google" (Gmail/Workspace SMTP).
        If no backend is configured, only DB persistence is performed.
      security:
        - FirebaseBearer: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateSupportTicketRequest"
      responses:
        "201":
          description: Support ticket created (stored in DB; email sent if backend configured)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateSupportTicketResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorEnvelope"
  /api/v1/upload/s3:
    post:
      summary: Create S3 presigned upload
      description: Returns a presigned URL for uploading a file to S3. Requires API key authentication.
      security:
        - FirebaseBearer: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PresignRequest"
      responses:
        "200":
          description: Presigned URL response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PresignResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SimpleError"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthError"
        "500":
          description: Internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SimpleError"
components:
  securitySchemes:
    FirebaseBearer:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: User API key (Bearer token)
  parameters:
    SpaceId:
      name: spaceId
      in: path
      required: true
      schema:
        type: string
    CollectionId:
      name: collectionId
      in: path
      required: true
      schema:
        type: string
    SourceId:
      name: sourceId
      in: path
      required: true
      schema:
        type: string
    ArtifactId:
      name: artifactId
      in: path
      required: true
      schema:
        type: string
    KeyId:
      name: keyId
      in: path
      required: true
      schema:
        type: string
  schemas:
    ResponseEnvelope:
      type: object
      additionalProperties: false
      properties:
        data:
          nullable: true
        metadata:
          nullable: true
        error:
          $ref: "#/components/schemas/ErrorResponse"
    ErrorResponse:
      type: object
      additionalProperties: false
      properties:
        code:
          type: string
        message:
          type: string
        details:
          nullable: true
      required: [code, message]
    ErrorEnvelope:
      allOf:
        - $ref: "#/components/schemas/ResponseEnvelope"
    AuthError:
      oneOf:
        - $ref: "#/components/schemas/ErrorEnvelope"
        - $ref: "#/components/schemas/SimpleError"
    SimpleError:
      type: object
      additionalProperties: false
      properties:
        error:
          type: string
      required: [error]
    CreateApiKeyRequest:
      type: object
      additionalProperties: false
      properties:
        name:
          type: string
        expiration_date:
          type: string
          format: date-time
          nullable: true
    ApiKeyResponse:
      type: object
      additionalProperties: false
      properties:
        id:
          type: string
        key_prefix:
          type: string
        name:
          type: string
        expiration_date:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        revoked_at:
          type: string
          format: date-time
          nullable: true
        api_key:
          type: string
          description: Only present on create response; store securely
      required: [id, created_at]
    ListApiKeysResponse:
      type: object
      additionalProperties: false
      properties:
        api_keys:
          type: array
          items:
            $ref: "#/components/schemas/ApiKeyResponse"
        pagination:
          type: object
          properties:
            page: { type: integer }
            per_page: { type: integer }
            total: { type: integer }
            pages: { type: integer }
      required: [api_keys, pagination]
    CreateSupportTicketRequest:
      type: object
      additionalProperties: false
      required: [type, reply_address, message]
      properties:
        type:
          type: string
          description: Ticket type (e.g. billing, technical, feedback)
        reply_address:
          type: string
          description: Email or address for support reply
        message:
          type: string
          description: User message
    CreateSupportTicketResponse:
      type: object
      additionalProperties: false
      required: [id, created_at, status, sent_at]
      properties:
        id:
          type: string
          description: Stored ticket ID
        created_at:
          type: string
          format: date-time
          description: Ticket creation time (DB)
        status:
          type: string
          example: sent
        sent_at:
          type: string
          format: date-time
    CreateSpaceRequest:
      type: object
      additionalProperties: false
      required: [name]
      properties:
        name:
          type: string
        description:
          type: string
        settings:
          type: object
          additionalProperties: true
    UpdateSpaceRequest:
      type: object
      additionalProperties: false
      properties:
        name:
          type: string
          nullable: true
        description:
          type: string
          nullable: true
        settings:
          type: object
          additionalProperties: true
    SpaceResponse:
      type: object
      additionalProperties: false
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
          nullable: true
        ownerId:
          type: string
        settings:
          type: object
          additionalProperties: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, name, ownerId, createdAt, updatedAt]
    ListSpacesResponse:
      type: object
      additionalProperties: false
      properties:
        spaces:
          type: array
          items:
            $ref: "#/components/schemas/SpaceResponse"
      required: [spaces]
    CreateCollectionRequest:
      type: object
      additionalProperties: false
      required: [name]
      properties:
        name:
          type: string
        parentId:
          type: string
          nullable: true
    CollectionResponse:
      type: object
      additionalProperties: false
      properties:
        id:
          type: string
        spaceId:
          type: string
        parentId:
          type: string
          nullable: true
        name:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, spaceId, name, createdAt, updatedAt]
    CollectionTreeResponse:
      type: object
      additionalProperties: false
      description: Collection node. The `children` array contains nested nodes with the same structure (recursive tree).
      properties:
        id:
          type: string
        spaceId:
          type: string
        parentId:
          type: string
          nullable: true
        name:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        children:
          type: array
          description: Child collection nodes (same structure, recursive).
          items:
            type: object
            additionalProperties: true
      required: [id, spaceId, name, createdAt, updatedAt, children]
    CreateSourceRequest:
      type: object
      additionalProperties: false
      required: [type, instructions, initial_data]
      properties:
        type:
          type: string
          enum: [URI, FILE, CONTENT, COMPOSITION]
        name:
          type: string
          nullable: true
        initial_data:
          $ref: "#/components/schemas/CreateSourceRequestInitialData"
        collectionId:
          type: string
          nullable: true
        instructions:
          type: object
          additionalProperties: true
        description:
          type: string
          nullable: true
    CreateSourceRequestInitialData:
      type: object
      additionalProperties: false
      description: |
        URI: url or uri required. COMPOSITION: source_ids required. FILE: data with fileKey from S3 presign response.
        CONTENT: data with inline content.
      properties:
        url:
          type: string
          nullable: true
          description: Source URL (for type URI). Use url or uri.
        uri:
          type: string
          nullable: true
          description: Alias for url (for type URI). Client may send either url or uri.
        source_ids:
          type: array
          items:
            type: string
          description: For type COMPOSITION.
        data:
          type: string
          nullable: true
          description: For FILE use fileKey from POST /upload/s3. For CONTENT use inline content.
    SourceReprocessRequest:
      type: object
      additionalProperties: false
      description: Optional body for source reprocess.
      properties:
        run_context_extraction:
          type: boolean
          description: Default true
        run_artifact_extraction:
          type: boolean
          description: Default true
        update_existing:
          type: boolean
          description: Default true; false to create new and enrich
    SourceRefreshRequest:
      type: object
      additionalProperties: false
      description: Optional body for source refresh. Only URL or FILE sources.
      properties:
        run_context_extraction:
          type: boolean
          description: Default true
        run_artifact_extraction:
          type: boolean
          description: Default true
    PromoteArtifactRequest:
      type: object
      additionalProperties: false
      description: Optional body for artifact promotion (title, description).
      properties:
        title:
          type: string
        description:
          type: string
    PatchSourceRequest:
      type: object
      additionalProperties: false
      properties:
        title:
          type: string
          nullable: true
        content:
          type: string
          nullable: true
        isPinned:
          type: boolean
          nullable: true
        isArchived:
          type: boolean
          nullable: true
    SourceResponse:
      type: object
      additionalProperties: false
      properties:
        id:
          type: string
        spaceId:
          type: string
        collectionId:
          type: string
          nullable: true
        userId:
          type: string
        type:
          type: string
          enum: [URI, FILE, CONTENT, COMPOSITION]
        status:
          type: string
          enum: [CREATED, PENDING, PROCESSING, COMPLETED, FAILED, CANCELED]
        userProgress:
          type: object
          additionalProperties: true
        title:
          type: string
        content:
          type: string
        isPinned:
          type: boolean
        artifacts:
          type: array
          items:
            type: string
        createdAt:
          type: string
        updatedAt:
          type: string
      required: [id, spaceId, userId, type, status, title, content, isPinned, artifacts, createdAt, updatedAt]
    SpaceSourcesResponse:
      type: object
      additionalProperties: false
      properties:
        sources:
          type: array
          items:
            $ref: "#/components/schemas/SourceResponse"
      required: [sources]
    ArtifactResponse:
      type: object
      additionalProperties: false
      properties:
        id:
          type: string
        space_id:
          type: string
        collection_id:
          type: string
          nullable: true
        name:
          type: string
        description:
          type: string
          nullable: true
        status:
          type: string
          enum: [CREATED, PENDING, PROCESSING, REVIEW, COMPLETED, FAILED]
        type:
          type: string
          enum: [context]
        modality:
          type: string
          enum: [text, image, video, audio, code]
        outline:
          type: object
          additionalProperties: true
        content:
          type: object
          additionalProperties: true
        meta:
          type: object
          additionalProperties: true
        createdAt:
          type: string
        updatedAt:
          type: string
        deletedAt:
          type: string
          nullable: true
    PresignRequest:
      type: object
      additionalProperties: false
      required: [filename, contentType]
      properties:
        filename:
          type: string
        contentType:
          type: string
        size:
          type: integer
          format: int64
    PresignResponse:
      type: object
      additionalProperties: false
      properties:
        uploadUrl:
          type: string
        publicUrl:
          type: string
        fileKey:
          type: string
      required: [uploadUrl, publicUrl, fileKey]
    HealthCheckResponse:
      type: object
      additionalProperties: false
      properties:
        status:
          type: string
        components:
          type: array
          items:
            type: object
            additionalProperties: true
        version:
          type: string
        timestamp:
          type: string
        redis_status:
          type: string
        service_state:
          type: string
      required: [status, components, version, timestamp, redis_status, service_state]
    MessageResponse:
      type: object
      additionalProperties: false
      properties:
        message:
          type: string
      required: [message]
    SpaceEnvelope:
      allOf:
        - $ref: "#/components/schemas/ResponseEnvelope"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/SpaceResponse"
    SpaceListEnvelope:
      allOf:
        - $ref: "#/components/schemas/ResponseEnvelope"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/ListSpacesResponse"
    CollectionEnvelope:
      allOf:
        - $ref: "#/components/schemas/ResponseEnvelope"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/CollectionResponse"
    CollectionTreeEnvelope:
      allOf:
        - $ref: "#/components/schemas/ResponseEnvelope"
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: "#/components/schemas/CollectionTreeResponse"
    SourceEnvelope:
      allOf:
        - $ref: "#/components/schemas/ResponseEnvelope"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/SourceResponse"
    SourceListEnvelope:
      allOf:
        - $ref: "#/components/schemas/ResponseEnvelope"
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: "#/components/schemas/SourceResponse"
    SpaceSourcesEnvelope:
      allOf:
        - $ref: "#/components/schemas/ResponseEnvelope"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/SpaceSourcesResponse"
    ArtifactListEnvelope:
      allOf:
        - $ref: "#/components/schemas/ResponseEnvelope"
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: "#/components/schemas/ArtifactResponse"
    HealthCheckEnvelope:
      allOf:
        - $ref: "#/components/schemas/ResponseEnvelope"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/HealthCheckResponse"
    MessageEnvelope:
      allOf:
        - $ref: "#/components/schemas/ResponseEnvelope"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/MessageResponse"
